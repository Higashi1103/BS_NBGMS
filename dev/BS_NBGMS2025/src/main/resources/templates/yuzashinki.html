<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<title>ユーザー新規｜技術者管理システム</title>
	<meta charset="utf-8">
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js"></script>
	<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap.min.css" rel="stylesheet">
	<style>
		html,
		body {
			width: 100%;
			height: 100%;
			overflow: auto;
			overflow-x: auto;
			overflow-y: auto;
		}

		.main-content {
			overflow-x: auto;
			overflow-y: auto;
		}

		.panel-body,
		#table-content {
			overflow-x: auto;
		}

		.navbar {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 51px;
			background-color: #f9f9f9;
			color: #000000;
			display: flex;
			align-items: center;
			padding: 0 10px;
			box-sizing: border-box;
			z-index: 1000;
			border-bottom: 1px solid #e5e5e5;
		}

		a {
			letter-spacing: 0.05em;
		}

		#title {
			position: absolute;
			left: 10px;
			top: 50%;
			transform: translateY(-50%);
			font-size: 18px;
			color: #777;
		}

		#user {
			position: absolute;
			right: 20px;
			top: 50%;
			transform: translateY(-50%);
			cursor: pointer;
		}

		.dropdown-menu {
			display: none;
			position: absolute;
			top: 40px;
			right: 0;
			transform: translateX(-90px);
			background-color: #fff;
			border: 1px solid #ddd;
			border-radius: 5px;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
			min-width: 110px;
			z-index: 2000;
		}

		.dropdown-menu a {
			display: block;
			padding: 8px 10px;
			color: #333;
			text-decoration: none;
			font-size: 14px;
		}

		.dropdown-menu a:hover {
			background-color: #f2f2f2;
		}


		.sidebar {
			position: fixed;
			top: 51px;
			left: 0;
			width: 250px;
			height: calc(100% - 51px);
			background-color: #f9f9f9;
			color: rgb(48, 48, 48);
			box-sizing: border-box;
			border-right: 1px solid #e5e5e5;
		}

		.sidebar-nav div {
			margin: 0;
			padding: 10px;
			border-bottom: 1px solid #e5e5e5;

		}

		.sidebar-nav div a {
			color: #337ab7;
			font-size: 14px;
			text-decoration: none;
			display: flex;
			align-items: center;
		}

		.sidebar-nav div:hover {
			background-color: #e6e6e6;
			color: #fff;
		}

		.main-content {
			margin-top: 30px;
			margin-left: 240px;
			padding: 40px;
			min-height: calc(100vh - 51px);
			background-color: #fff;
			display: flex;
			justify-content: center;
		}

		#shousaitable {
			width: 1060px;
			table-layout: auto;
		}

		.span-css {
			background-color: #d9534f;
			color: #fff;
			font-size: 12px;
			padding: 1px 5px;
			border-radius: 3px;
			margin-left: 5px;
			align-self: center;
		}

		.form-group {
			display: flex;
			flex-direction: column;
			margin-bottom: 12px;
		}

		.label-css {
			display: flex;
			align-items: center;
			margin-bottom: 4px;
			font-weight: 600;
			line-height: 1.3;
			letter-spacing: 0.03em;
		}

		.center {
			text-align: center;
		}

		.dialogBtns {
			display: flex;
			justify-content: center;
			gap: 20px;
			margin-top: 0px;
		}

		.overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100vw;
			height: 100vh;
			background: rgba(0, 0, 0, 0.45);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 9999;
		}

		.success-icon {
			color: green;
			font-weight: bold;
		}

		.error-text {
			color: crimson;
			left: 0;
			font-size: 14px;
			margin-top: 2px;
			line-height: 1.2;
			top: 100%;
		}

		.overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100vw;
			height: 100vh;
			background: rgba(0, 0, 0, 0.45);
			place-items: center;
			z-index: 9999;
		}

		.dialog {
			background: white;
			border-radius: 12px;
			width: 400px;
			height: auto;
			max-height: 90vh;
			overflow-y: auto;
			padding-bottom: 50px;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
			z-index: 10000;
		}

		.dlgTitle {
			background-color: #f0ad4e;
			margin-top: 0;
			margin-bottom: 42px;
			border-radius: 12px 12px 0px 0px;
			padding: 10px;
			border-bottom: 1px solid gray;
			color: white
		}

		.dlgTitleMsg {
			background-color: #5bc0de;
			margin-top: 0;
			margin-bottom: 42px;
			border-radius: 12px 12px 0px 0px;
			padding: 10px;
			border-bottom: 1px solid gray;
			color: white
		}

		.dlgTitleConfirm {
			background-color: #f0ad4e;
			margin-top: 0;
			margin-bottom: 42px;
			border-radius: 12px 12px 0px 0px;
			padding: 10px;
			border-bottom: 1px solid gray;
			color: white
		}

		.input-error {
			border-color: #a94442;
			box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075), 0 0 6px rgba(169, 68, 66, .6);
			;
		}
	</style>

</head>

<body>
	<!-- ヘッド -->
	<nav class="navbar" style="margin-bottom: 0">
		<div id="title">技術者管理システム</div>

		<!-- ログアウトバタン -->
		<div id="user">
			<img src="/image/user.png" height="25px">
			<div class="dropdown-menu" id="dropdownMenu">
				<a href="/maipeji">マイページ</a>
				<a href="/yuzaichiran">ユーザー一覧</a>
				<a href="/logout" id="logoutLink">ログアウト</a>
			</div>
		</div>

		<!-- 左ナビ -->
		<div class="sidebar">
			<div class="sidebar-nav">
				<div>
					<a th:href="@{/kurasu}"><img src="/image/kurasu.png" height="18px"
							style="margin-right: 5px;">クラス情報</a>
				</div>
				<div>
					<a th:href="@{/gakusei}"><img src="/image/gakusei.png" height="18px"
							style="margin-right: 5px;">学生情報</a>
				</div>
				<div>
					<a th:href="@{/tensu}"><img src="/image/pointo.png" height="18px"
							style="margin-right: 5px;">ポイント履歴</a>
				</div>
				<div>
					<a th:href="@{/hiaringu}"><img src="/image/hiaringu.png" height="18px"
							style="margin-right: 5px;">ヒアリング履歴</a>
				</div>
				<div>
					<a th:href="@{/shuturyoku}"><img src="/image/shutsuryoku.png" height="18px"
							style="margin-right: 5px;">出力</a>
				</div>
			</div>
		</div>
	</nav>
	<div class="main-content">
		<div id="table-content">
			<div class="col-lg-12">
				<div class="panel panel-default" style="width: 1090px;">
					<div class="panel-heading">個人情報
					</div>
					<div class="panel-body">
						<form id="yuzaForm" action="/yuzaSave" method="post">

							<label for="yuzaId" class="label-css">
								ID：
								<span class="span-css">必須</span>
							</label>
							<input type="text" name="yuzaId" id="yuzaId" class="form-control">
							<div id="idError" class="error-text"
								style="color: crimson; font-size: 14px; margin-top: 2px;">
							</div><br>

							<label for="yuzaPwd" class="label-css">
								パスワード：
								<span class="span-css">必須</span>
							</label>
							<input type="text" name="yuzaPwd" id="yuzaPwd" class="form-control">
							<div id="pwdError" class="error-text"
								style="color: crimson; font-size: 14px; margin-top: 2px;">
							</div><br>

							<label for="yuzaNamae" class="label-css">
								名前：
							</label>
							<input type="text" name="yuzaNamae" id="yuzaNamae" class="form-control">
							<div id="namaeError" class="error-text"
								style="color: crimson; font-size: 14px; margin-top: 2px;"></div><br>

							<div style="margin-top: 9px; display: flex; justify-content: flex-end;">
								<button type="submit" class="btn btn-success">登録</button>　
								<a th:href="@{/yuzaichiran}" class="btn btn-warning">戻る</a>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="logoutOverlay" style="
							    position: fixed;
							    top: 0; left: 0;
							    width: 100%; height: 100%;
							    background: rgba(0, 0, 0, 0.5);
							    display: none;
							    justify-content: center;
							    align-items: center;
							    z-index: 9999;">
		<div class="dialog">
			<p class="dlgTitle">確認</p>
			<div class="center">
				<p>本当にログアウトしますか？</p>
				<br>
			</div>
			<div class="dialogBtns">
				<button id="logoutYes" class="btn btn-success">確認</button>
				<button id="logoutNo" class="btn btn-warning">戻る</button>
			</div>
		</div>
	</div>

	<div id="overlay" class="overlay" style="display:none;" role="dialog" aria-modal="true">
		<div id="dialog" class="dialog" tabindex="-1">
			<h4 class="dlgTitle">確認</h4>
			<div class="center" id="confirmContent">

			</div>
			<div class="dialogBtns">
				<input id="confirmUpdate" type="button" value="登録" class="btn btn-success">
				<input id="returnUpdate" type="button" value="キャンセル" class="btn btn-warning">
			</div>
		</div>
	</div>

	<div id="successOverlay" class="overlay" style="display:none;" role="dialog" aria-modal="true">
		<div id="dialog" class="dialog" tabindex="-1">
			<h4 class="dlgTitleMsg">通知</h4>
			<div style="text-align:center">
				<p>登録できました。</p>
				<br>
				<input id='subReturnUpdate' type='button' value='確認' onclick="location.href='/yuzaichiran'"
					class="btn btn-warning">
			</div>
		</div>
	</div>

	<div id="errorOverlay" class="overlay" style="display:none;" role="dialog" aria-modal="true">
		<div id="dialog" class="dialog" tabindex="-1">
			<h4 class="dlgTitle" style="background-color: #c9302c;">エラー</h4>
			<div class="center">
				<h5>登録不可、入力項目を確認してください。</h5>
				<br>
			</div>
			<div class="center">
				<input id="return" type="button" value="戻る" class="btn btn-warning">
			</div>
		</div>
	</div>

	<script>
		document.addEventListener('DOMContentLoaded', function () {

			const logoutLink = document.getElementById('logoutLink');
			const logoutOverlay = document.getElementById('logoutOverlay');
			const logoutYes = document.getElementById('logoutYes');
			const logoutNo = document.getElementById('logoutNo');

			if (logoutLink) {
				logoutLink.addEventListener('click', function (e) {
					e.preventDefault();
					logoutOverlay.style.display = 'flex';
				});
			}

			if (logoutNo) {
				logoutNo.addEventListener('click', function () {
					logoutOverlay.style.display = 'none';
				});
			}

			if (logoutYes) {
				logoutYes.addEventListener('click', function () {
					window.location.href = '/logout';
				});
			}
		});

		$(function () {
			$('#user').on('click', function (e) {
				e.stopPropagation();
				$('#dropdownMenu').toggle();
			});

			$(document).on('click', function () {
				$('#dropdownMenu').hide();
			});
		});

		$(document).ready(function () {
			$('#dataTables-example').DataTable({
				responsive: true
			});
		});


		$(document).ready(function () {

			function validateId() {
				const idVal = $("#yuzaId").val().trim();
				$("#idError").html("");
				$("#yuzaId").removeClass("input-error");

				if (idVal === "") {
					$("#idError").html("IDを入力してください。");
					$("#yuzaId").addClass("input-error");
					return false;
				} else if (/[Ａ-Ｚａ-ｚ０-９]/.test(idVal)) {
					$("#idError").html("IDは半角で入力してください。");
					$("#yuzaId").addClass("input-error");
					return false;
				} else if (!/^[A-Za-z0-9]+$/.test(idVal)) {
					$("#idError").html("IDは英字と数字のみ入力できます。");
					$("#yuzaId").addClass("input-error");
					return false;
				} else if (idVal.length < 3 || idVal.length > 12) {
					$("#idError").html("IDは3～12文字で入力してください。");
					$("#yuzaId").addClass("input-error");
					return false;
				} else {
					$("#idError").html('<span class="success-icon" style="color:green;">✔</span>');
					return true;
				}
			}

			function validatePwd() {
				const pwdVal = $("#yuzaPwd").val().trim();
				$("#pwdError").html("");
				$("#yuzaPwd").removeClass("input-error");

				if (pwdVal === "") {
					$("#pwdError").html("パスワードを入力してください。");
					$("#yuzaPwd").addClass("input-error");
					return false;
				} else if (/[Ａ-Ｚａ-ｚ０-９]/.test(pwdVal)) {
					$("#pwdError").html("パスワードは半角で入力してください。");
					$("#yuzaPwd").addClass("input-error");
					return false;
				} else if (!/^[A-Za-z0-9_-]+$/.test(pwdVal)) {
					$("#pwdError").html("パスワードは英字、数字、ハイフン（-）、アンダーバー（_）のみ入力できます。");
					$("#yuzaPwd").addClass("input-error");
					return false;
				} else if (pwdVal.length < 5 || pwdVal.length > 16) {
					$("#pwdError").html("パスワードは5～16文字で入力してください。");
					$("#yuzaPwd").addClass("input-error");
					return false;
				} else {
					$("#pwdError").html('<span class="success-icon" style="color:green;">✔</span>');
					return true;
				}
			}

			function validateNamae() {
				const namaeVal = $("#yuzaNamae").val().trim();
				$("#namaeError").html("");
				$("#yuzaNamae").removeClass("input-error");

				if (namaeVal !== "") {
					if (namaeVal.length < 2 || namaeVal.length > 20) {
						$("#namaeError").html("名前は2～20文字で入力してください。");
						$("#yuzaNamae").addClass("input-error");
						return false;
					} else {
						$("#namaeError").html('<span class="success-icon" style="color:green;">✔</span>');
						return true;
					}
				} else {
					$("#namaeError").html("");
					return true;
				}
			}

			$("#yuzaId").on("blur", validateId);
			$("#yuzaPwd").on("blur", validatePwd);
			$("#yuzaNamae").on("blur", validateNamae);

			$("#yuzaForm").submit(function (e) {
				e.preventDefault();

				const idOk = validateId();
				const pwdOk = validatePwd();
				const namaeOk = validateNamae();

				if (!idOk || !pwdOk || !namaeOk) {
					$("#errorOverlay").css("display", "flex");
					return;
				}

				const idVal = $("#yuzaId").val().trim();
				$.ajax({
					url: "/checkYuzaId",
					type: "GET",
					data: {yuzaId: idVal},
					success: function (exists) {
						if (exists === true || exists === "true") {
							$("#idError").html("このIDは既に存在しています。");
							$("#yuzaId").addClass("input-error");
						} else {
							const confirmHtml = `
                        <p>以下の内容をご確認の上、</p>
                        <p>「登録」ボタンを押してください。</p><br>
                        <p>ID：${idVal}</p>
                        <p>パスワード：${$("#yuzaPwd").val()}</p>
                        <p>名前：${$("#yuzaNamae").val() || "（未入力）"}</p><br>
                    `;
							$("#confirmContent").html(confirmHtml);
							$("#overlay").css("display", "flex");
						}
					},
					error: function () {
						$("#idError").html("サーバーエラーが発生しました。");
						$("#yuzaId").addClass("input-error");
					}
				});
			});


			$("#confirmUpdate").click(function () {
				$("#overlay").hide();

				$.ajax({
					url: "/yuzaSave",
					type: "POST",
					data: $("#yuzaForm").serialize(),
					success: function () {
						$("#successOverlay").css("display", "flex");
					},
					error: function () {
						alert("登録に失敗しました。");
					}
				});
			});

			$("#returnUpdate").click(function () {
				$("#overlay").hide();
			});
		});
		$("#return").click(function () {
			$("#errorOverlay").hide();
		});
	</script>
</body>

</html>