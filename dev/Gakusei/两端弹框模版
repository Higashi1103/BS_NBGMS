<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>技術者管理システム</title>
    <meta charset="utf-8">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap.min.css" rel="stylesheet">

    <!-- 新規画面内容チェックのJS -->
    <script th:src="@{/js/updateCheckForm.js}"></script>

    <style>
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 51px;
            background-color: #f9f9f9;
            color: #000000;
            display: flex;
            align-items: center;
            padding: 0 10px;
            box-sizing: border-box;
            z-index: 1000;
            border-bottom: 1px solid #e5e5e5;
        }

        #title {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: #777;
        }

        #user {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 40px;
            right: 0;
            transform: translateX(-100px);
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            min-width: 100px;
            z-index: 2000;
        }

        .dropdown-menu a {
            display: block;
            padding: 8px 10px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
        }

        .dropdown-menu a:hover {
            background-color: #f2f2f2;
        }

        .sidebar {
            position: fixed;
            top: 51px;
            left: 0;
            width: 250px;
            height: calc(100% - 51px);
            background-color: #f9f9f9;
            color: rgb(48, 48, 48);
            box-sizing: border-box;
            border-right: 1px solid #e5e5e5;
        }

        .sidebar-nav div {
            margin: 0;
            padding: 10px;
            border-bottom: 1px solid #e5e5e5;
        }

        .sidebar-nav div a {
            color: #454545;
            font-size: 14px;
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .sidebar-nav div:hover {
            background-color: #e6e6e6;
            color: #fff;
        }

        .main-content {
            margin-top: 30px;
            margin-left: 240px;
            padding: 40px;
            min-height: calc(100vh - 51px);
            background-color: #fff;
            display: flex;
            justify-content: center;
        }

        /* 有 “必须” 字段的 span 样式 */
        .span-css {
            background-color: #d9534f;
            color: #fff;
            font-size: 12px;
            padding: 1px 5px;
            border-radius: 3px;
            margin-left: 5px;
            align-self: center;
            /* 与文字垂直对齐 */
        }

        /* label + input 一起放 flex，自动对齐高度 */
        .form-group {
            display: flex;
            flex-direction: column;
            /* label 在上，input 在下 */
            margin-bottom: 12px;
        }

        /* label 基本样式 */
        .label-css {
            display: flex;
            align-items: center;
            /* 强制让文字和“必須”标签垂直居中对齐 */
            margin-bottom: 4px;
            /* label 和输入框间距 */
            font-weight: 600;
            line-height: 1.3;
            letter-spacing: 0.03em;
        }
===========================================================================
        /* 弹框样式 */
        .overlay {
            display: none;
            position: fixed;
            /* 固定在视口，而不是文档流 */
            top: 0;
            left: 0;
            width: 100vw;
            /* 覆盖整个可视宽度 */
            height: 100vh;
            /* 覆盖整个可视高度 */
            background: rgba(0, 0, 0, 0.45);
            /* 半透明遮罩 */
            place-items: center;
            z-index: 9999;
            /* 超高层级，保证在所有元素上方 */
        }

        .dialog {
            background: white;
            border-radius: 12px;
            width: 400px;
            height: auto;
            max-height: 90vh;
            overflow-y: auto;
            padding-bottom: 50px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            /* 比遮罩略高，但一般只要父层够高就行 */
        }

        .dlgTitle {
            background-color: #d9534f;
            margin-top: 0;
            margin-bottom: 42px;
            border-radius: 12px 12px 0px 0px;
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid gray;
            color: white
        }

        .dlgTitleMsg {
            background-color: #5bc0de;
            margin-top: 0;
            margin-bottom: 42px;
            border-radius: 12px 12px 0px 0px;
            padding: 10px;
            border-bottom: 1px solid gray;
            color: white
        }

        .dlgTitleConfirm {
            background-color:#f0ad4e; 
            margin-top:0; 
            margin-bottom:42px; 
            border-radius:12px 12px 0px 0px;
            padding: 10px;
            border-bottom:1px solid gray; 
            color:white
        }

=========================================================
        .center {
            text-align: center;
        }

        .flex {
            display: flex;
        }

        .update {
            margin-right: 15px;
        }

        .margin-left {
            margin-left: auto;
        }

        .margin-bottom {
            display: inline-block;
            margin-bottom: 6px;
        }

        .float-right {
            float: right;
        }
===============================================================
        /* エラー表示を美しく整える */
        .form-group {
            position: relative;
            /* 让子元素绝对定位时的参考基准 */
        }

        /* 所有 Error 提示浮动在输入框下方，不撑开布局 */
        .form-group span[id$="Error"] {
            position: absolute;
            top: 100%;
            /* 紧贴输入框底部 */
            left: 0;
            font-size: 14px;
            margin-top: 2px;
            color: red;
            line-height: 1.2;
        }

        /* 如果想让成功的 ✓ 也对齐显示，可以加一点绿色字体样式 */
        .form-group span[id$="Error"]:contains("✓") {
            color: green;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div id="title">技術者管理システム</div>

        <div id="user">
            <img src="/image/user.png" height="25px">
            <div class="dropdown-menu" id="dropdownMenu">
                <a href="#">ログアウト</a>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-nav">
                <div><a th:href="@{/kurasu}"><img src="/image/kurasu.png" height="18px"
                            style="margin-right: 5px;">クラス情報</a></div>
                <div><a th:href="@{/gakusei}"><img src="/image/gakusei.png" height="18px"
                            style="margin-right: 5px;">学生情報</a></div>
                <div><a th:href="@{/tensu}"><img src="/image/pointo.png" height="18px"
                            style="margin-right: 5px;">ポイント履歴</a></div>
                <div><a th:href="@{/hiaringu}"><img src="/image/hiaringu.png" height="18px"
                            style="margin-right: 5px;">ヒアリング履歴</a></div>
                <div><a th:href="@{/shuturyoku}"><img src="/image/shutsuryoku.png" height="18px"
                            style="margin-right: 5px;">出力</a></div>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <div id="table-content">
            <div class="col-lg-12">
                <div class="panel panel-default" style="width: 1090px;">
                    <div class="panel-heading">学生情報更新</div>
                    <div id="panel-body" class="panel-body">

                        <!-- 更新画面内容 -->
                        <form id="updateForm">
                            <!-- ✅ 隐藏字段：主键 -->
                            <input type="hidden" name="gakuseiId" th:value="${singleGakusei.gakuseiId}">

                            <div class="row">
                                <!-- 左列 -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="name" class="label-css">
                                            学生名前:
                                            <span class="span-css">必須</span>
                                        </label>
                                        <input id="name" type="text" name="namae" class="form-control"
                                            th:value="${singleGakusei.namae}">
                                        <span id="nameError"></span>
                                    </div>
                                    <br>

                                    <div class="form-group">
                                        <label for="gender" class="label-css">
                                            性別:
                                            <span class="span-css">必須</span>
                                        </label>
                                        <select id="gender" name="seibetsu" class="form-control">
                                            <option value="">性別を選択してください</option>
                                            <option value="男" th:selected="${singleGakusei.seibetsu} == '男'">男
                                            </option>
                                            <option value="女" th:selected="${singleGakusei.seibetsu} == '女'">女
                                            </option>
                                        </select>
                                        <span id="genderError"></span>
                                    </div>
                                    <br>

                                    <div class="form-group">
                                        <label for="birthday" class="label-css">
                                            生年月日:
                                            <span class="span-css">必須</span>
                                        </label>
                                        <input id="birthday" type="text" name="seinengappi" class="form-control"
                                            th:value="${singleGakusei.seinengappi}">
                                        <span id="birthdayError"></span>
                                    </div>
                                    <br>

                                    <div class="form-group">
                                        <label for="education" class="label-css">
                                            最終学歴:
                                            <span class="span-css">必須</span>
                                        </label>
                                        <select id="education" name="saishuGakureki" class="form-control">
                                            <option value="">最終学歴を選択してください</option>
                                            <option value="大学" th:selected="${singleGakusei.saishuGakureki} == '大学'">大学
                                            </option>
                                            <option value="大学院" th:selected="${singleGakusei.saishuGakureki} == '大学院'">
                                                大学院</option>
                                            <option value="短期大学"
                                                th:selected="${singleGakusei.saishuGakureki} == '短期大学'">短期大学
                                            </option>
                                            <option value="専門学校"
                                                th:selected="${singleGakusei.saishuGakureki} == '専門学校'">専門学校
                                            </option>
                                            <option value="高校" th:selected="${singleGakusei.saishuGakureki} == '高校'">高校
                                            </option>
                                        </select>
                                        <span id="educationError"></span>
                                    </div>
                                    <br>

                                    <div class="form-group">
                                        <label for="languagelevel" class="label-css">
                                            語学力:
                                            <span class="span-css">必須</span>
                                        </label>
                                        <select id="languagelevel" name="gogakuryoku" class="form-control">
                                            <option value="">語学力を選択してください</option>
                                            <option value="N1" th:selected="${singleGakusei.gogakuryoku} == 'N1'">N1
                                            </option>
                                            <option value="N2" th:selected="${singleGakusei.gogakuryoku} == 'N2'">N2
                                            </option>
                                            <option value="N3" th:selected="${singleGakusei.gogakuryoku} == 'N3'">N3
                                            </option>
                                            <option value="N4" th:selected="${singleGakusei.gogakuryoku} == 'N4'">N4
                                            </option>
                                            <option value="N5" th:selected="${singleGakusei.gogakuryoku} == 'N5'">N5
                                            </option>
                                        </select>
                                        <span id="languagelevelError"></span>
                                    </div>
                                    <br>
                                </div>

                                <!-- 右列 -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="kurasuId" class="label-css">
                                            クラス名:
                                            <span class="span-css">表示のみ</span>
                                        </label>
                                        <input id="kurasuNamae" name="kurasuNamae" class="form-control"
                                            th:value="${singleGakusei.kurasuNamae}" readonly
                                            style="background-color:#f5f5f5;">

                                        <!-- 隠したクラスID（更新時に使用） -->
                                        <input type="hidden" id="kurasuId" name="kurasuId"
                                            th:value="${singleGakusei.kurasuId}">
                                    </div>
                                    <br>

                                    <div class="form-group">
                                        <label for="score" class="label-css">
                                            点数:
                                            <span class="span-css">必須</span>
                                        </label>
                                        <input id="score" name="tensu" class="form-control"
                                            th:value="${singleGakusei.tensu}">
                                        <span id="scoreError"></span>
                                    </div>
                                    <br>

                                    <div class="form-group">
                                        <label for="evaluation" class="label-css">
                                            評価:
                                        </label>
                                        <input id="evaluation" name="hyouka" class="form-control"
                                            th:value="${singleGakusei.hyouka}">
                                    </div>
                                    <br>

                                    <div class="form-group">
                                        <label for="other" class="label-css">
                                            その他:
                                        </label>
                                        <input id="other" name="sonota" class="form-control"
                                            th:value="${singleGakusei.sonota}">
                                    </div>
                                    <br>
                                </div>
                            </div>

                            <!-- 按钮居右对齐 -->
                            <div class="text-right" style="margin-top: 15px;">
                                <input type="button" value="更新" id="updateBtn" class="btn btn-info"
                                    style="margin-right: 15px;">
                                <input type="button" value="戻る" th:onclick="|location.href='@{/gakusei}'|"
                                    class="btn btn-warning">
                            </div>

                        </form>
                    </div>

                    <!-- 弹框框架 -->
                    <div id="overlay" class="overlay" role="dialog" aria-modal="true">
                        <div id="dialog" class="dialog" tabindex="-1">
                            <h4 class="dlgTitle">入力項目確認</h4>
                            <div class="center">
                            </div>
                            <div id="dialogBtns">
                                <input id="confirmUpdate" type="button" value="確認" class="btn btn-info">
                                <input id="returnUpdate" type="button" value="キャンセル" class="btn btn-warning">
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

</body>
<script>
    $(function () {

        // 更新ボタンクリック時
        $('#updateBtn').click(function () {
            // 调用共通チェック
            if (!updateCheckForm()) return;

            // 获取输入值
            const name = $('#name').val();
            const gender = $('#gender').val();
            const birthday = $('#birthday').val();
            const education = $('#education').val();
            const languagelevel = $('#languagelevel').val();
            const score = $('#score').val();
            const kurasuNamae = $('#kurasuNamae').val();
            const kurasuId = $('#kurasuId').val(); // ← 隠し主キー(外部キー)
            const evaluation = $('#evaluation').val();
            const other = $('#other').val();

            // ✅ 弹框显示（只在点击后执行）
            $('#overlay').fadeIn({
                duration: 270,
                start: function () {
                    $(this).css({ 'display': 'grid', 'place-items': 'center' });
                }
            });

            // ========================== 动态填入弹窗内容  第一段弹框 ==============================
            $('#overlay').html(`
            <div id="dialog" class="dialog" tabindex="-1">
                <h4 class="dlgTitleConfirm">確認</h4>	
                <div class="center">
                    <p>学生名前：${name}</p>
                    <p>クラス名：${kurasuNamae}</p>
                    <p>点数：${score}</p>
                </div>
                <br>
                <div class="center">
                    <input id="confirmUpdate" type="button" value="更新" class="btn btn-info update">
                    <input id="returnUpdate" type="button" value="戻る" class="btn btn-warning">
                </div>
            </div>
        `);

            $('#confirmUpdate').focus();

            // ✅ Tab / ESC
            $('#overlay').on('keydown.focusTrap', function (e) {
                const active = document.activeElement;
                if (e.key === 'Tab') {
                    if (!e.shiftKey && active === $('#returnUpdate')[0]) {
                        e.preventDefault();
                        $('#confirmUpdate').focus();
                    } else if (e.shiftKey && active === $('#confirmUpdate')[0]) {
                        e.preventDefault();
                        $('#returnUpdate').focus();
                    }
                } else if (e.key === 'Escape') {
                    $('#overlay').hide().off('keydown.focusTrap');
                }
            });

            // =========================================- Ajax提交  第二段弹框 ======================================
            $('#confirmUpdate').one('click', function () {
                $.ajax({
                    url: '/gakusei/updateGakuseiInfo',
                    type: 'post',
                    data: {
                        gakuseiId: $('#updateForm input[name="gakuseiId"]').val(), // ← 一定要带上主键！
                        namae: name,
                        seibetsu: gender,
                        seinengappi: birthday,
                        saishuGakureki: education,
                        gogakuryoku: languagelevel,
                        kurasuId: kurasuId,
                        kurasuNamae: kurasuNamae,
                        tensu: score,
                        hyouka: evaluation,
                        sonota: other
                    },
                    success: function () {
                        $('#overlay').fadeIn({ duration: 270, start: function () { $(this).css({ 'display': 'grid', 'place-items': 'center' }) } });
                        $('#overlay').html(`
									<div id="dialog" class="dialog" tabindex="-1">
										<h4 class="dlgTitleMsg">通知</h4>	
										<div style="text-align:center">
											<p>更新できました。</p >
											<br>
											<input id='subReturnUpdate' type='button' value='戻る' onclick="location.href='/gakusei'" class="btn btn-warning">
										</div>	
									</div>	
										`);
                        $('#subReturnUpdate').focus();
                        $('#overlay').on('keydown.focusTrap', function (e) {
                            if (e.key === 'Tab') {
                                const active = document.activeElement;

                                if (!e.shiftKey && active === $('#subReturnUpdate')[0]) {
                                    e.preventDefault();
                                    $('#subReturnUpdate').focus();
                                } else if (e.shiftKey && active === $('#subReturnUpdate')[0]) {
                                    e.preventDefault();
                                    $('#subReturnUpdate').focus();
                                }
                            }
                        })
                    },
                    error: function () {
                        alert('更新できませんでした');
                    }
                });
            });

            // ✅ 返回按钮
            $('#returnUpdate').click(function () {
                $('#overlay').hide().off('keydown.focusTrap');
            });
        });
    });
</script>

</html>
